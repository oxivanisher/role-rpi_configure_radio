---
# ensure mounted boot
- name: Mount boot
  ansible.posix.mount:
    path: /boot
    state: mounted
    src: /dev/mmcblk0p1
    fstype: vfat
  changed_when: false

- name: "Disable wifi in /boot/config.txt"
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: "dtoverlay=disable-wifi"
    line: "dtoverlay=disable-wifi"
  notify: Reboot required
  when: rpi_disable_radio_wifi
  ignore_errors: "{{ ansible_check_mode }}"

- name: "Enable wifi in /boot/config.txt"
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: "dtoverlay=disable-wifi"
    line: "#dtoverlay=disable-wifi"
  notify: Reboot required
  when: not rpi_disable_radio_wifi
  ignore_errors: "{{ ansible_check_mode }}"

- name: "Disable bluetooth in /boot/config.txt"
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: "dtoverlay=disable-bt"
    line: "dtoverlay=disable-bt"
  notify: Reboot required
  when: rpi_disable_radio_bt
  ignore_errors: "{{ ansible_check_mode }}"

- name: "Enable bluetooth in /boot/config.txt"
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: "dtoverlay=disable-bt"
    line: "#dtoverlay=disable-bt"
  notify: Reboot required
  when: not rpi_disable_radio_bt
  ignore_errors: "{{ ansible_check_mode }}"

# Inspired by https://github.com/guysoft/OctoPi/issues/508
- name: Remove buggy wlan0 powersave file from octopi
  ansible.builtin.file:
    path: /etc/network/if-up.d/powersave_off
    state: absent

- name: Create systemd unit to handle wifi powersave
  ansible.builtin.file:
    src: wifi_powersave@.service
    dest: /etc/systemd/system/wifi_powersave@.service
    owner: root
    group: root
    mode: "0644"
  when: not rpi_disable_radio_wifi

- name: Enable the systemd unit to handle wifi powersave
  ansible.builtin.service:
    name: wifi_powersave@off.service
    state: started
    enabled: true
  when: not rpi_disable_radio_wifi

- name: Disable the systemd unit to handle wifi powersave
  ansible.builtin.service:
    name: wifi_powersave@off.service
    enabled: false
  when: rpi_disable_radio_wifi
